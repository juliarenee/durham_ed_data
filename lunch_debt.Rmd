---
title: "Unpaid Lunch Debt in Durham, NC"
author: "Julia Donheiser"
date: "11/2/2018"
output: pdf_document
urlcolor: blue
---

## Introduction
When families can’t afford to pay for student lunches, school districts foot the bill. But with major cuts to educational funding in North Carolina—where some schools don’t even have enough funds to pay for students’ textbooks—this means school districts can wrack up tens of thousands of dollars in debt. In Durham, students with five or more unpaid lunches only receive a juice and a sandwich instead of a hot lunch. This lends its way to “lunch shaming”, where students who can’t afford pay skip the meal altogether to avoid the embarrassment of eating a cold lunch. This is a major issue, since student performance in school is directly tied to access to quality food.

### Data Sources
* End-of-Year unpaid meal data from James Keaton, director of child nutrition services at DPS.
* All free/reduced price lunch data was obtained from \href{http://www.ncpublicschools.org/fbs/resources/data/}{ncpublicschools.org}
* 2010-11 through 2015-16 demographic data was obtained from the \href{https://nces.ed.gov/ccd/elsi/tableGenerator.aspx}{NCES ELSI table generator}, code 91803
* 2017-18 ADM data from ncpublicschools.org's \href{http://www.ncpublicschools.org/fbs/accounting/data/}{Average Daily Membership and Membership Last Day by School}
```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE, message = FALSE)

library(readxl) # read spreadsheets
library(dplyr) # wrangling
library(ggplot2) # graphing
library(tidyr) # reshaping
library(stringr) # string manipulation
library(data.table) # working with tables
library(cowplot) # layout plots
```
```{r free_reduced_data, include=FALSE}
# get all older files, .xls format
old.dat = list.files("./data") %>%
  grep("freereduced.xls$", ., value = TRUE)

# read files as table
dat = lapply(paste("./data/",old.dat,sep=""), function(x) read_xls(x))

# clean empty rows
head(dat[[1]])
colnames(dat[[1]]) = c("lea_no","lea_name","school_no","school_name","adm","reduced","free","pct_needy","grade")
dat[[1]] = dat[[1]][2:dim(dat[[1]])[1],]
head(dat[[2]])
colnames(dat[[2]]) = c("lea_no","lea_name","school_no","school_name","adm","reduced","free","pct_needy","grade")
dat[[2]] = dat[[2]][5:dim(dat[[2]])[1],]
head(dat[[3]])
colnames(dat[[3]]) = c("lea_no","lea_name","school_no","school_name","adm","reduced","free","pct_needy","grade")
dat[[3]] = dat[[3]][7:dim(dat[[3]])[1],]
head(dat[[4]])
colnames(dat[[4]]) = c("lea_no","lea_name","school_no","school_name","adm","reduced","free","pct_needy","grade")
dat[[4]] = dat[[4]][7:dim(dat[[4]])[1],]
head(dat[[5]])
colnames(dat[[5]]) = c("lea_no","lea_name","school_no","school_name","cep","adm","free","reduced","pct_needy","pct_needy_mlt")

# get newer files, .xlsx format
new.dat = list.files("./data") %>%
  grep("freereduced.xlsx$", ., value = TRUE)
dat2 = lapply(paste("./data/",new.dat,sep=""), function(x) read_xlsx(x))

# check for cleaning
head(dat2[[1]])
colnames(dat2[[1]]) = c("lea_no","lea_name","school_no","school_name","cep","adm","free","reduced","pct_needy","pct_needy_mlt")
head(dat2[[2]])
colnames(dat2[[2]]) = c("lea_no","lea_name","school_no","school_name","cep","adm","free","reduced","pct_needy")

# join all data
dat[6:7] = dat2

# transform to data frames
dat = lapply(dat, function(x) data.frame(x))

# remove totals (last row)
dat = lapply(dat, function(x) x[-nrow(x),])

# add id for year
yrs = c(old.dat, new.dat) %>% substr(., 0, 7) # get year to bind as column
for(i in 1:length(dat)) {
  dat[[i]]$year = yrs[i]
}

# merge
df = do.call(plyr::rbind.fill, dat)

# indicator for CEP data
df$cep = ifelse(is.na(df$cep), 0, 1)

# filter to durham county
df = df[grepl("Durham", df$lea_name, ignore.case = TRUE),]
```
```{r lunch_debt_data, include=FALSE}
# load lunch debt data
debt = read.csv("./data/meal_debt.csv")
debt = debt[1:nrow(debt)-1,1:10] # remove totals at bottom, only full year data
colnames(debt)[1:2] = c("school_no", "school_name")
colnames(debt)[3:9] = yrs # reform years
colnames(debt)[10] = "2017-18"

# reshape wide to long
debt = gather(debt, year, unpaid, 3:10)

# convert to integer
debt$unpaid = debt$unpaid %>%
  gsub("\\$","",.) %>%
  gsub("\\,","",.) %>%
  as.numeric()

# convert to factor for joining
df$school_no = as.factor(df$school_no)
debt$school_no = as.factor(debt$school_no)

# join unpaid lunch with free/reduced lunch data
df = left_join(debt, df, by = c("year","school_no"))

# dedupe school name cols
colnames(df)[which(colnames(df)=="school_name.x")] = "school_name"
colnames(df)[which(colnames(df)=="school_name.y")] = "school_name2"

# year as factor
df$year = as.factor(df$year)

# character to numeric
df[c("adm","reduced","free","pct_needy")] = sapply(df[c("adm","reduced","free","pct_needy")], as.numeric)
```
```{r 17-18adm_data, include=FALSE}
# add 2017-18 adm data
adm17 = read.csv("./data/2017-18adm.csv")

# filter to durham
adm17 = adm17[grepl("Durham", adm17$LEA.Name, ignore.case = TRUE),]

# only need adm and school number
adm17 = adm17[c("SCH","Total")]

# total as numeric
adm17$Total = as.character(adm17$Total) %>% trimws(.) %>% gsub("\\,","",.) %>% as.numeric()

# fill 2017-18 adm data
df$adm[df$year=="2017-18"] = adm17$Total[df$school_no[df$year=="2017-18"]]
```
```{r demographic_data}
# add demographic data
dem = read.csv("./data/nces_demographics.csv")

# remove state, only NC
dem = dem[-c(2)]

# also remove summary rows
spchars = c("†","‡","–")
dem = dem[!grepl(paste(spchars,collapse="|"),dem$School.Name),]

# split to datasets by year
dem11 = dem[c(1, grep("2010\\.11",colnames(dem)))]
dem12 = dem[c(1, grep("2011\\.12",colnames(dem)))]
dem13 = dem[c(1, grep("2012\\.13",colnames(dem)))]
dem14 = dem[c(1, grep("2013\\.14",colnames(dem)))]
dem15 = dem[c(1, grep("2014\\.15",colnames(dem)))]
dem16 = dem[c(1, grep("2015\\.16",colnames(dem)))]

# vectorize
x = list(dem11, dem12, dem13, dem14, dem15, dem16)

# FUNCTION: reformat column names
changeNames = function(z) {
  newNames = colnames(z) %>%
    gsub("\\.+","\\_",.) %>%
    tolower() %>%
    gsub("\\_students.*","",.) %>%
    gsub("\\_public_school.*","",.)
  colnames(z) = newNames
  return(z)
}

# apply to dataframes
x = lapply(x, changeNames)

# add year as variable
for(i in 1:length(x)) {
  x[[i]]$year = yrs[i]
}

# merge to dataframe
dem = do.call(rbind, x)

# set non-numeric values
dem[dem==spchars[1]] = NA
dem[dem==spchars[2]] = NA
dem[dem==spchars[3]] = NA

# all vars as char
dem[,1:14] = lapply(dem[,1:14],as.character)

# set alternative zeros to 0
dem[dem=="=0"] = 0
dem[dem=="=000"] = 0

# filter to durham
dem = dem[grepl("Durham", dem$county_name, ignore.case = TRUE),]

# clean school num
dem$state_school_id[nchar(dem$state_school_id) > 3] = dem$state_school_id[nchar(dem$state_school_id) > 3] %>% substr(., nchar(.)-2, nchar(.))

# vars to numeric
dem[,c(2:9)] = lapply(dem[,c(2:9)],as.numeric)

# merge with df
df = left_join(df, dem, by=c("school_no"="state_school_id","year"))
```

## Exploratory Data Analysis
### Longitudinal look at debt from 2010-11 through 2017-18
```{r debt_over_time, fig.width=8, fig.height=4}
# normalize debt by adm
df$debt_per_student = df$unpaid/df$adm

# debt by school over time
p1 = ggplot(df, aes(year, unpaid, group = school_no, col = school_no)) +
  geom_point() +
  geom_line() +
  ylab("total debt") +
  ggtitle("Total Debt by School") +
  scale_y_continuous(labels = scales::dollar) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
        axis.title.x = element_blank(),
        plot.title = element_text(size = 12))

# debt/student over time
p2 = ggplot(df, aes(year, debt_per_student, group = school_no, col = school_no)) +
  geom_point() +
  geom_line() +
  ylab("debt per student") +
  ggtitle("Debt per Student by School") +
  scale_y_continuous(labels = scales::dollar) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
        axis.title.x = element_blank(),
        plot.title = element_text(size = 12))

plot_grid(p1, p2)
```

There's a lot of fluctuation in debt-per-student and total debt by school over time. Let's try to see which schools have the most variation in debt-per-student, and highest average debt-per-student.

I also looked at the mean and variance of debt per student by school. This gives us a sense of \textit{how} much debt per student fluctuates within in each school. Schools with a high variance should be looked into---perhaps fluctuations in debt are tied to CEP status? Or someone bailing a school out of debt? Similarly, schools with a generally high mean debt per student are of interest. Why are these schools struggling more than others?

### Mean and variance of debt within schools
```{r histograms, fig.width=8, fig.height=4}
# calculate mean and variance of debt/student by school
sums = df %>%
  group_by(school_no) %>%
  summarise(mean_debt = mean(debt_per_student, na.rm = TRUE),
            var = var(debt_per_student, na.rm = TRUE)) %>%
  arrange(-var)

# histogram of mean debt per student
h1 = ggplot(sums, aes(mean_debt)) +
  geom_histogram() +
  xlab("mean") +
  scale_x_continuous(labels = scales::dollar) +
  theme(legend.position = "none",
        plot.margin = margin(2, 0, 2, 2, "cm"))

# histogram of variance of mean debt per student
h2 = ggplot(sums, aes(var)) +
  geom_histogram() +
  xlab("variance") +
  scale_x_continuous(labels = scales::dollar) +
  theme(legend.position = "none",
        plot.margin = margin(1, 0, 2, 2, "cm"))

plot_grid(h1, h2,
          labels = c("Mean Debt-per-Student","Within-School Variance"),
          label_size = 12)
```

There are definitely some outliers in our data when it comes to variance of within-school debt per student and mean debt-per-student. Let's pull any schools that fall greater than 2 standard deviations from the mean (proper outliers) and see what their debt-per-student looks like longitudinally.

### High variance schools
```{r high_var, fig.width=12, fig.height=4}
# grab school codes for high variance
high.var = sums$school_no[sums$var > 100]

# debt/student over time
p1 = ggplot(df[df$school_no %in% high.var,], aes(year, debt_per_student, group = school_no, col = school_no)) +
  geom_point() +
  geom_line() +
  ylab("Debt-per-Student") +
  scale_y_continuous(labels = scales::dollar) +
  scale_fill_manual(labels = names) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
        axis.title.x = element_blank(),
        plot.title = element_text(size = 12))

# total debt over time
p2 = ggplot(df[df$school_no %in% high.var,], aes(year, unpaid, group = school_no, col = school_no)) +
  geom_point() +
  geom_line() +
  ylab("Total Debt") +
  scale_y_continuous(labels = scales::dollar) +
  scale_fill_manual(labels = names) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
        axis.title.x = element_blank(),
        plot.title = element_text(size = 12))


grid = plot_grid(p1 + theme(legend.position = "none"),
          p2 + theme(legend.position = "none"),
          legend = get_legend(p1),
          ncol = 3)

plot_grid(ggdraw() + draw_label("Schools with Most Variance of Debt-per-Student (Var > 100)", size = 12),
          grid, ncol = 1, rel_heights=c(0.1, 1))
```

### Schools with the most debt
```{r mean_debt, fig.width=12, fig.height=4}
# calculate z-scores for mean debt per student
sums$z_debt = scale(sums$mean_debt, center = TRUE, scale = TRUE)

high.debt = sums$school_no[sums$z_debt >= 2]

# z-score greater than 2 is an outlier, plot those schools over time
p1 = ggplot(df[df$school_no %in% high.debt,], aes(year, debt_per_student, group = school_no, col = school_no)) +
  geom_point() +
  geom_line() +
  ylab("Debt-per-Student") +
  scale_y_continuous(labels = scales::dollar) +
  scale_fill_manual(labels = names) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 10))

# z-score greater than 2 is an outlier, plot those schools over time
p2 = ggplot(df[df$school_no %in% high.debt,], aes(year, unpaid, group = school_no, col = school_no)) +
  geom_point() +
  geom_line() +
  ylab("Total Debt") + 
  scale_y_continuous(labels = scales::dollar) +
  scale_fill_manual(labels = names) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 10))

grid = plot_grid(p1 + theme(legend.position = "none"),
          p2 + theme(legend.position = "none"),
          legend = get_legend(p1),
          ncol = 3)

plot_grid(ggdraw() + draw_label("Schools with Outlier Mean Debt-per-Student (Z > 2)", size = 12),
          grid, ncol = 1, rel_heights=c(0.1, 1))
```

### CEP Schools
```{r cep_schools, fig.width=12, fig.height=4}
# grab schools with CEP status at any point in time
cep.schools = df %>%
  group_by(school_no) %>%
  filter(sum(cep, na.rm = TRUE) > 0) %>%
  select(school_no)

cep = df[df$school_no %in% unique(cep.schools$school_no),]

# cep as factor
cep$cep = as.factor(cep$cep)

# debt/student over time
p1 = ggplot(cep, aes(year, debt_per_student, group = school_no)) +
  geom_point(aes(col = cep)) +
  geom_line() +
  ylab("Debt-per-Student") +
  scale_y_continuous(labels = scales::dollar) +
  scale_fill_manual(labels = names) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
        axis.title.x = element_blank(),
        plot.title = element_text(size = 12))

# total debt over time
p2 = ggplot(cep, aes(year, unpaid, group = school_no)) +
  geom_point(aes(col = cep)) +
  geom_line() +
  ylab("Total Debt") +
  scale_y_continuous(labels = scales::dollar) +
  scale_fill_manual(labels = names) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
        axis.title.x = element_blank(),
        plot.title = element_text(size = 12))


grid = plot_grid(p1 + theme(legend.position = "none"),
          p2 + theme(legend.position = "none"),
          legend = get_legend(p1),
          ncol = 3)

plot_grid(ggdraw() + draw_label("CEP Schools", size = 12),
          grid, ncol = 1, rel_heights=c(0.1, 1))
```


FOR NEXT WEEK:
- get 2010-11, 2011-12, 2012-13, 2013-14 and 2017-18 CEP data
- ask about when school lunch data pulled
- get demographic data for 2016-17 and 2017-18 academic years


- external factors (paying off debt, CEP status)
  - how to track people paying off debt/dates?
- think about fairly comparing schools
- LONG TERM: can a student graduate with debt? are they barred from anything? what are consequences besides food?