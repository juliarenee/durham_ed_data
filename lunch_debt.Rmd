---
title: "Unpaid Lunch Debt in Durham, NC"
author: "Julia Donheiser"
date: "11/2/2018"
output: pdf_document
---

Looking at school lunch debt in Durham, North Carolina. EOY unpaid meal data from James Keaton, director of child nutrition services at DPS. Free/reduced price lunch data was obtained from \href{http://www.ncpublicschools.org/fbs/resources/data/}{ncpublicschools.org}. Demographic data was obtained from the \href{https://nces.ed.gov/ccd/elsi/tableGenerator.aspx}{NCES ELSI table generator}. You can access this specific table using the code 91803.

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE)

library(readxl) # read spreadsheets
library(dplyr) # wrangling
library(ggplot2) # graphing
library(tidyr) # reshaping
library(stringr) # string work
library(data.table) # working with tables

# get all older files, .xls format
old.dat = list.files("./data") %>%
  grep(".xls$", ., value = TRUE)

# read files as table
dat = lapply(paste("./data/",old.dat,sep=""), function(x) read_xls(x))

# clean empty rows
head(dat[[1]])
colnames(dat[[1]]) = c("lea_no","lea_name","school_no","school_name","adm","reduced","free","pct_needy","grade")
dat[[1]] = dat[[1]][2:dim(dat[[1]])[1],]
head(dat[[2]])
colnames(dat[[2]]) = c("lea_no","lea_name","school_no","school_name","adm","reduced","free","pct_needy","grade")
dat[[2]] = dat[[2]][5:dim(dat[[2]])[1],]
head(dat[[3]])
colnames(dat[[3]]) = c("lea_no","lea_name","school_no","school_name","adm","reduced","free","pct_needy","grade")
dat[[3]] = dat[[3]][7:dim(dat[[3]])[1],]
head(dat[[4]])
colnames(dat[[4]]) = c("lea_no","lea_name","school_no","school_name","adm","reduced","free","pct_needy","grade")
dat[[4]] = dat[[4]][7:dim(dat[[4]])[1],]
head(dat[[5]])
colnames(dat[[5]]) = c("lea_no","lea_name","school_no","school_name","cep","adm","free","reduced","pct_needy","pct_needy_mlt")

# get newer files, .xlsx format
new.dat = list.files("./data") %>%
  grep(".xlsx$", ., value = TRUE)
dat2 = lapply(paste("./data/",new.dat,sep=""), function(x) read_xlsx(x))

# check for cleaning
head(dat2[[1]])
colnames(dat2[[1]]) = c("lea_no","lea_name","school_no","school_name","cep","adm","free","reduced","pct_needy","pct_needy_mlt")
head(dat2[[2]])
colnames(dat2[[2]]) = c("lea_no","lea_name","school_no","school_name","cep","adm","free","reduced","pct_needy")

# join all data
dat[6:7] = dat2

# transform to data frames
dat = lapply(dat, function(x) data.frame(x))

# remove totals (last row)
dat = lapply(dat, function(x) x[-nrow(x),])

# add id for year
yrs = c(old.dat, new.dat) %>% substr(., 0, 7) # get year to bind as column
for(i in 1:length(dat)) {
  dat[[i]]$year = yrs[i]
}

# merge
df = do.call(plyr::rbind.fill, dat)

# filter to durham county
df = df[grepl("Durham", df$lea_name, ignore.case = TRUE),]

# load lunch debt data
debt = read.csv("./data/meal_debt.csv")
debt = debt[1:nrow(debt)-1,1:10] # remove totals at bottom, only full year data
colnames(debt)[1:2] = c("school_no", "school_name")
colnames(debt)[3:9] = yrs # reform years
colnames(debt)[10] = "2017-18"

# reshape wide to long
debt = gather(debt, year, unpaid, 3:10)

# convert to integer
debt$unpaid = debt$unpaid %>%
  gsub("\\$","",.) %>%
  gsub("\\,","",.) %>%
  as.numeric()

# convert to factor for joining
df$school_no = as.factor(df$school_no)
debt$school_no = as.factor(debt$school_no)

# join unpaid lunch with free/reduced lunch data
df = left_join(debt, df, by = c("year","school_no"))

# dedupe school name cols
colnames(df)[which(colnames(df)=="school_name.x")] = "school_name"
colnames(df)[which(colnames(df)=="school_name.y")] = "school_name2"

# year as factor
df$year = as.factor(df$year)

# character to numeric
df[c("adm","reduced","free","pct_needy")] = sapply(df[c("adm","reduced","free","pct_needy")], as.numeric)

# add demographic data
dem = read.csv("./data/nces_demographics.csv")

# remove state, only NC
dem = dem[-c(2)]

# reshape to get year as variable
dem = gather(dem, var, val, 2:73)

# remove id rows
spchars = c("†","‡","–")
dem = dem[!grepl(paste(spchars,collapse="|"),dem$School.Name),]

# add year as variable
dem$year = dem$var %>%
  substr(., nchar(.)-6, nchar(.)) %>% 
  gsub("\\.","\\-",.)

# remove year and "public school" from var name
dem$var = dem$var %>%
  substr(., 0, nchar(.)-24)

# set non-numeric values
dem$val[dem$val %in% spchars] = NA

# set alternative zeros to 0
dem$val[dem$val %in% c("=0","=000")] = 0

# long to wide
dem = dcast(dem, School.Name + year ~ var, value.var = "val")

## WHY ISN'T THIS WORKING!

# edit column names
colnames(dem) = colnames(dem) %>%
  gsub("\\.+","_",.) %>%
  tolower(.)

colnames(dem) = colnames(dem) %>% gsub("\\_students","",.)

# filter to durham
dem = dem[grepl("Durham", dem$county_name, ignore.case = TRUE),]
```

## EDA
```{r}
# normalize debt by adm
df$debt_per_student = df$unpaid/df$adm

# debt by school over time
ggplot(df, aes(year, debt_per_student, group = school_no, col = school_no)) +
  geom_point() +
  geom_line() +
  xlab("unpaid lunch debt") + 
  ggtitle("Unpaid Lunch Debt by School") +
  scale_y_continuous(labels = scales::dollar) +
  theme(legend.position = "none")

# debt/student over time
ggplot(df, aes(year, debt_per_student, group = school_no, col = school_no)) +
  geom_point() +
  geom_line() +
  xlab("unpaid lunch debt") +
  ggtitle("Unpaid Lunch Debt per Student by School") +
  scale_y_continuous(labels = scales::dollar) +
  theme(legend.position = "none")
```

When we look at total unpaid lunch debt as well as per student, we see a lot of variation. Let's try to find which schools fluctuate most when it comes to school lunch debt.

```{r}
# calculate mean and variance of debt/student by school
sums = df %>%
  group_by(school_no) %>%
  summarise(mean_debt = mean(debt_per_student, na.rm = TRUE),
            var = var(debt_per_student, na.rm = TRUE)) %>%
  arrange(-var)

# histogram of mean debt per student
ggplot(sums, aes(mean_debt)) +
  geom_histogram() +
  xlab("mean debt per student") +
  scale_x_continuous(labels = scales::dollar)

# histogram of variance of mean debt per student
ggplot(sums, aes(var)) +
  geom_histogram() +
  xlab("variance of mean debt per student") +
  scale_x_continuous(labels = scales::dollar)
```

Some schools have really high variance. Let's check those out longitudinally.

```{r}
# grab school codes for high variance
high.var = sums$school_no[sums$var > 100]

# debt/student over time
ggplot(df[df$school_no %in% high.var,], aes(year, debt_per_student, group = school_no, col = school_no)) +
  geom_point() +
  geom_line() +
  xlab("unpaid lunch debt") +
  ggtitle("Unpaid Lunch Debt per Student by School") +
  scale_y_continuous(labels = scales::dollar) +
  scale_fill_manual(labels = names)
```

Debt decreased dramatically over multiple years for these schools. What happened?

Let's also look at schools with outlier values for mean debt.

```{r}
# calculate z-scores for mean debt per student
sums$z_debt = scale(sums$mean_debt, center = TRUE, scale = TRUE)

high.debt = sums$school_no[sums$z_debt >= 2]

# z-score greater than 2 is an outlier, plot those schools over time
ggplot(df[df$school_no %in% high.debt,], aes(year, debt_per_student, group = school_no, col = school_no)) +
  geom_point() +
  geom_line() +
  xlab("unpaid lunch debt") +
  ggtitle("Unpaid Lunch Debt per Student by School") +
  scale_y_continuous(labels = scales::dollar) +
  scale_fill_manual(labels = names)
```


- get additional demographics, fill missing adm numbers
- break into bins by mean value/variance
- external factors (paying off debt, CEP status)
- add CEP status binary
- double check merges, wrangling
- think through when data is being pulled
  - how to track people paying off debt/dates?
- think about fairly comparing schools
- LONG TERM: can a student graduate with debt? are they barred from anything? what are consequences besides food?