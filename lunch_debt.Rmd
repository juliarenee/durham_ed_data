---
title: "Unpaid Lunch Debt in Durham, NC"
author: "Julia Donheiser"
date: "11/2/2018"
output: pdf_document
---

Looking at school lunch debt in Durham, North Carolina. EOY unpaid meal data from James Keaton, director of child nutrition services at DPS. Other demographic data obtained from \href{http://www.ncpublicschools.org/fbs/resources/data/}{ncpublicschools.org}.

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE)

library(readxl) # read spreadsheets
library(dplyr) # wrangling
library(ggplot2) # graphing
library(tidyr) # reshaping
library(stringr) # string work
library(data.table) # working with tables
library(plyr) # more wrangling

# get all older files, .xls format
old.dat = list.files("./data") %>%
  grep(".xls$", ., value = TRUE)

# read files as table
dat = lapply(paste("./data/",old.dat,sep=""), function(x) read_xls(x))

# clean empty rows
head(dat[[1]])
colnames(dat[[1]]) = c("lea_no","lea_name","school_no","school_name","adm","reduced","free","pct_needy","grade")
dat[[1]] = dat[[1]][2:dim(dat[[1]])[1],]
head(dat[[2]])
colnames(dat[[2]]) = c("lea_no","lea_name","school_no","school_name","adm","reduced","free","pct_needy","grade")
dat[[2]] = dat[[2]][5:dim(dat[[2]])[1],]
head(dat[[3]])
colnames(dat[[3]]) = c("lea_no","lea_name","school_no","school_name","adm","reduced","free","pct_needy","grade")
dat[[3]] = dat[[3]][7:dim(dat[[3]])[1],]
head(dat[[4]])
colnames(dat[[4]]) = c("lea_no","lea_name","school_no","school_name","adm","reduced","free","pct_needy","grade")
dat[[4]] = dat[[4]][7:dim(dat[[4]])[1],]
head(dat[[5]])
colnames(dat[[5]]) = c("lea_no","lea_name","school_no","school_name","cep","adm","free","reduced","pct_needy","pct_needy_mlt")

# get newer files, .xlsx format
new.dat = list.files("./data") %>%
  grep(".xlsx$", ., value = TRUE)
dat2 = lapply(paste("./data/",new.dat,sep=""), function(x) read_xlsx(x))

# check for cleaning
head(dat2[[1]])
colnames(dat2[[1]]) = c("lea_no","lea_name","school_no","school_name","cep","adm","free","reduced","pct_needy","pct_needy_mlt")
head(dat2[[2]])
colnames(dat2[[2]]) = c("lea_no","lea_name","school_no","school_name","cep","adm","free","reduced","pct_needy")

# join all data
dat[6:7] = dat2

# transform to data frames
dat = lapply(dat, function(x) data.frame(x))

# remove totals (last row)
dat = lapply(dat, function(x) x[-nrow(x),])

# add id for year
yrs = c(old.dat, new.dat) %>% substr(., 0, 7) # get year to bind as column
for(i in 1:length(dat)) {
  dat[[i]]$year = yrs[i]
}

# merge
df = do.call(rbind.fill, dat)

# filter to durham county
df = df[grepl("Durham", df$lea_name, ignore.case = TRUE),]

# load lunch debt data
debt = read.csv("./data/meal_debt.csv")
debt = debt[1:nrow(debt)-1,1:10] # remove totals at bottom, only full year data
colnames(debt)[1:2] = c("school_no", "school_name")
colnames(debt)[3:9] = yrs # reform years
colnames(debt)[10] = "2017-18"

# reshape wide to long
debt = gather(debt, year, unpaid, 3:10)

# convert to integer
debt$unpaid = debt$unpaid %>%
  gsub("\\$","",.) %>%
  gsub("\\,","",.) %>%
  as.numeric()

# convert to factor for joining
df$school_no = as.factor(df$school_no)
debt$school_no = as.factor(debt$school_no)

# join unpaid lunch with free/reduced lunch data
df = left_join(debt, df, by = c("year","school_no"))

# dedupe school name cols
colnames(df)[which(colnames(df)=="school_name.x")] = "school_name"
colnames(df)[which(colnames(df)=="school_name.y")] = "school_name2"

# year as factor
df$year = as.factor(df$year)

# character to numeric
df[c("adm","reduced","free","pct_needy")] = sapply(df[c("adm","reduced","free","pct_needy")], as.numeric)

# add demographic data
dem = read.csv("./data/nces_demographics.csv")

# remove state, only NC
dem = dem[-c(2)]

# reshape to get year as variable
dem = gather(dem, var, val, 2:73)

# remove id rows
spchars = c("†","‡","–")
dem = dem[!grepl(paste(spchars,collapse="|"),dem$School.Name),]

# add year as variable
dem$year = dem$var %>%
  substr(., nchar(.)-6, nchar(.)) %>% 
  gsub("\\.","\\-",.)

# remove year and "public school" from var name
dem$var = dem$var %>%
  substr(., 0, nchar(.)-24)

# set non-numeric values
dem$val[dem$val %in% spchars] = NA

# set alternative zeros to 0
dem$val[dem$val %in% c("=0","=000")] = 0

# long to wide
dem = dcast(dem, School.Name + year ~ var, value.var = "val")

## WHY ISN'T THIS WORKING!

# edit column names
colnames(dem) = colnames(dem) %>%
  gsub("\\.+","_",.) %>%
  tolower(.)

colnames(dem) = colnames(dem) %>% gsub("\\_students","",.)

# filter to durham
dem = dem[grepl("Durham", dem$county_name, ignore.case = TRUE),]
```

## EDA
```{r}
# debt by school over time
ggplot(df, aes(year, unpaid, group = school_no, col = school_no)) +
  geom_point() +
  geom_line() +
  xlab("unpaid Lunch Debt") + 
  scale_y_continuous(labels = scales::dollar)

# debt/student over time
ggplot(df, aes(year, unpaid/adm, group = school_no, col = school_no)) +
  geom_point() +
  geom_line() +
  xlab("unpaid Lunch Debt") + 
  scale_y_continuous(labels = scales::dollar)
```

- get additional demographics, fill missing adm numbers
- look at schools where variance is high
- break into bins by mean value/variance
- external factors (paying off debt, CEP status)
- add CEP status binary
- for next week: lots of eda, ready to formulate questions
- double check merges, wrangling
- think through when data is being pulled
  - how to track people paying off debt/dates?
- think about fairly comparing schools
- LONG TERM: can a student graduate with debt? are they barred from anything? what are consequences besides food?